//–ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª .env
require('dotenv').config();

const { Telegraf, Markup } = require('telegraf');
const dateFormat = require('dateformat');
const axios = require('axios');

//–ü–æ–¥–∫–ª—é—á–∞–µ–º –±–æ—Ç–∞
const bot = new Telegraf(process.env.BOT_KEY);

//–§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
function displayData(response, ctx){
    //–ü–æ–ª—É—á–µ–Ω–∏–µ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
    let date = new Date(response.data.dt * 1000);

    //–û–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –±—É–¥–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    const objData = {
        //–ì–æ—Ä–æ–¥
        city: response.data.name,
        //–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–≥–æ–¥—ã
        description: response.data.weather[0].description,
        //–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
        temp: Math.round(response.data.main.temp),
        //–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –æ—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫
        feels: Math.round(response.data.main.feels_like),
        //–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ —Ç–µ—á–µ–Ω–∏–∏ –¥–Ω—è
        max_temp: Math.round(response.data.main.temp_min),
        //–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ —Ç–µ—á–µ–Ω–∏–∏ –¥–Ω—è
        min_temp: Math.round(response.data.main.temp_max),
        //–°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞ –≤ –º/c
        speed: response.data.wind.speed,
        //–°–∫–æ—Ä–æ—Å—Ç—å –ø–æ—Ä—ã–≤–æ–≤ –≤–µ—Ç—Ä–∞ –≤ –º/c
        //–µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –±—É–¥–µ—Ç, —Ç–æ –ø—Ä–æ—Å—Ç–æ –≤—ã–≤–æ–¥–∏–º –ù/–î
        gust: typeof response.data.wind['gust'] === 'undefined' ? '–Ω/–¥' : response.data.wind.gust,
        //–î–∞—Ç–∞
        date: dateFormat(date, 'mm/dd/yyyy'),
    };

    //–°–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –º—ã –±—É–¥–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    let message = 
        `üèô –ì–æ—Ä–æ–¥: ${objData.city} \n\n`+
        `ü™ü –ó–∞ –æ–∫–Ω–æ–º: ${objData.description}\n\n`+
        `üå°–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${objData.temp} ¬∞C \n`+
        `üå°–ß—É–≤—Å—Ç–≤—É–µ—Ç—Å—è –∫–∞–∫: ${objData.feels} ¬∞C\n`+
        `üå°–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${objData.min_temp} ¬∞C\n`+
        `üå°–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${objData.max_temp} ¬∞C\n\n`+
        `üå¨–°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞: ${objData.speed} –º/c \n`+
        `üå¨–°–∫–æ—Ä–æ—Å—Ç—å –ø–æ—Ä—ã–≤–æ–≤ –≤–µ—Ç—Ä–∞: ${objData.gust} –º/c \n\n`+
        `–î–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã –Ω–∞: ${objData.date} \n\n` +
        `–ü—Ä–æ—Å—Ç–æ –Ω–∞–∑–æ–≤–∏ –º–Ω–µ –≥–æ—Ä–æ–¥, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –ø–æ–≥–æ–¥—É‚òÄÔ∏è`
    ;
    
    //–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    ctx.replyWithHTML(message);
}

//–§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
async function getData(ctx, city){
    try{
        //–û–±—Ä–∞—â–∞–µ–º—Å—è –∫ API
        const weatherApiUrl = `http://api.openweathermap.org/data/2.5/weather?q=${city}&appid=23b4efd808e30bf5cdf4eb817c1da6e5&units=metric&lang=ru`;
        //–û—Ç–≤–µ—Ç –æ—Ç API –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é response
        const response = await axios.get(weatherApiUrl);

        //–í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        displayData(response, ctx);
    } catch(e) {
        //–ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤—ë–ª –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –≥–æ—Ä–æ–¥, —Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–º—É —Å–æ–æ–±—â–µ–Ω–∏–µ
        ctx.replyWithHTML("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –º—ã –Ω–µ –Ω–∞—à–ª–∏ –≥–æ—Ä–æ–¥ –∫–æ—Ç–æ—Ä—ã–π –≤—ã —É–∫–∞–∑–∞–ª–∏ :( \n\n" + "–ù–∞–∑–æ–≤–∏—Ç–µ –¥—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥‚òÄÔ∏è");
    }
}

//–ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞ –≤—ã–¥–∞—ë–º —Å–æ–æ–±—â–µ–Ω–∏–µ
bot.start((ctx) => ctx.replyWithHTML("–ü—Ä–∏–≤–µ—Ç!üëã \n\n" + "–ü—Ä–æ—Å—Ç–æ –Ω–∞–∑–æ–≤–∏ –º–Ω–µ –≥–æ—Ä–æ–¥, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –ø–æ–≥–æ–¥—É‚òÄÔ∏è"));

//–ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –ª—é–±–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç—É –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å
//–ù–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–≥–æ–¥–µ
bot.on('message', (ctx) => {
    getData(ctx, ctx.message.text);
});

//–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
bot.launch();